<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{css/style.css}">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
</head>
<body>
<article>

    <div class="container" role="main">
        <h2>작성된 게시물</h2>
        <form class="form-group" th:method="post" th:action th:object="${board}">
            <div class="mb-3">
                <label for="title">제목</label>
                <textarea type="text" class="form-control" name="title" id="title" readonly="readonly" th:text="*{title}"></textarea>
            </div>
            <hr>
            <div class="mb-3">
                <label for="title">작성자</label>
                <textarea type="text" class="form-control" name="writer" id="writer" readonly="readonly" th:text="*{writer}"></textarea>
            </div>
            <hr>
            <div class="mb-3">
                <label for="content">내용</label>
                <textarea class="form-control" rows="10" name="content" id="content" readonly="readonly" th:text="*{content}"></textarea>
            </div>
        </form>
        <hr>
            <div class="mb-3">
                <section>
                    <div th:class="|reply_list${board.id}|">

                    </div>

                    <div class="mb-3" style="display: flex;">
                        <input type="text" class="form-control" name="cContent" id="cContent" placeholder="댓글을 입력해 주세요">
                        <button type="button" th:onclick="commentPost()" class="btn btn-default btn-lg btn3d right" id="cBtn">댓글작성</button>
                    </div>
                </section>
            </div>
        <hr>
        <div >
            <button type="btn" th:onclick="|location.href='@{/main/board}'|" class="btn btn-default btn-lg btn3d right" id="btnList">목록</button>
        </div>

    </div>
</article>
</body>
<script th:inline="javascript">
    var boardId = [[${board.id}]];
    var commentUrl = boardId + "/comment";
    $(function(){
        commentLoad(boardId)
    });

    const commentLoad = function(no) {

        $.ajax({
            url : commentUrl,
            type : 'get',
            dataType : "json",
            success : function (data) {
                console.log("댓글 Load");

                let html = "";
                for (const i in data) {
                    let cId = data[i].id;
                    let writer = data[i].writer;
                    let content = data[i].content;
                    let writeTime = data[i].writeTime;

                    html += "<div style='border: 1px solid black; margin-bottom: 5px'>";
                    html += "<div>";
                    html += "<b>" + "작성자 :" + writer + "</b>";
                    html += "</div>";
                    html += "<div>";
                    html += "내용 "  + content;
                    html += "</div>";
                    html += "<div>";
                    html += "작성 시간 " + writeTime;
                    html += "</div>";
                    if (writer == [[ ${student.nickname }]]) {
                        html += "<div>";
                        html += "<a href='javacript:void(0);' onclick='commentDelete(" + cId + ")'>댓글 삭제</a>";
                        html += "</div>";
                    }
                    html += "</div>";
                };
                $(".reply_list"+no).html(html);
            },
            error:function () {
                alert('서버 에러');
            }
        });
    };

    const commentPost = function() {
        let content = document.getElementById("cContent");

        $.ajax({
            url : commentUrl,
            type : 'post',
            contentType: "application/json",
            data: JSON.stringify({
                "content" : content.value
            }),
            success : function (data) {
                console.log("댓글 저장 성공");
                commentLoad(boardId);
                content.value = "";
            },
            error:function () {
                alert('서버 에러');
            }
        });
    }

    const commentDelete = function(commentId) {

        $.ajax({
            url : commentUrl,
            type : 'delete',
            contentType: "application/json",
            data: JSON.stringify({
                "commentId" : commentId
            }),
            success : function (data) {
                console.log("댓글 삭제 성공");
                commentLoad(boardId);
            },
            error:function () {
                alert('댓글삭제 에러');
            }
        });
    }
</script>
</html>